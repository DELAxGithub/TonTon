# 特記事項

## HealthKit連携について

### 取得データの範囲
- アクティブカロリーのみを取得
- 基礎代謝はアプリ内で計算（年齢、性別、体重から算出）
- 歩数データは取得するが、現状未使用

### 同期タイミング
- アプリ起動時
- 手動同期ボタン押下時
- バックグラウンド更新（未実装）

## OpenAI API連携

### システムプロンプト
食事写真分析用のプロンプト:
```typescript
private static readonly SYSTEM_PROMPT = 
  'あなたは食事の写真から内容とカロリーを分析するアシスタントです。' +
  '写真に写っている食事の内容を簡潔に説明し、カロリーを推定してください。' +
  '必ず {"description": "食事の説明", "calories": 推定カロリー} の形式のJSONで返答してください。' +
  'カロリーは必ず数値で返してください。余計な説明は不要です。';
```

### レスポンス形式
必ず以下のJSON形式で返却される必要があります：
```json
{
  "description": "string",
  "calories": number
}
```

### エラーハンドリング
- APIキー未設定
- ネットワークエラー
- レスポンス形式不正
- タイムアウト（30秒）

## データ永続化

### MMKVストレージ
- 暗号化未対応
- 大量データ時のパフォーマンス低下に注意
- バックアップ機能未実装

### データ構造
各データは以下の形式で保存:
```typescript
{
  id: string;          // UUID
  timestamp: number;   // UNIX timestamp
  ...データ固有のフィールド
}
```

## パフォーマンス最適化

### 画像処理
- 撮影/選択時に1024x1024pxにリサイズ
- JPEG圧縮率: 0.7
- Base64エンコード時のメモリ使用に注意

### データ取得
- ページネーション未実装
- 一度に全データを読み込み

## 今後の注意点

1. OpenAI API
   - プロンプトの最適化が必要
   - コスト管理の実装検討
   - バックアップモデルの検討

2. HealthKit
   - バックグラウンド更新の実装
   - データ同期の最適化
   - エラー時のリトライ処理

3. データ管理
   - MMKVの暗号化対応
   - バックアップ/リストア機能
   - データ移行機能

4. UI/UX
   - ローディング表示の改善
   - エラーメッセージの改善
   - オフライン対応 